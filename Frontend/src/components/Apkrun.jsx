import React, { useState } from 'react';
import { useLocation } from 'react-router-dom';

const Apkrun = () => {
  const location = useLocation();
  const { apk } = location.state || [];

  const [loading, setLoading] = useState(false);
  const [message, setMessage] = useState('');

  const getApkName = (apkPath) => {
    const parts = apkPath.split('/');
    return parts[parts.length - 1]; 
  };

  const handleRunApk = (apkPath) => {
    const cleanedPath = apkPath.replace('package:', ''); 
    setLoading(true); 
    setMessage(''); 

    fetch(`http://localhost:4003/run-apk`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ apkPath: cleanedPath })
    })
    .then(response => response.json())
    .then(data => {
      console.log('APK is being pulled: ', data);
      setMessage(`APK downloaded successfully! Download path: ${data.downloadPath}`);
    })
    .catch(error => {
      console.error('Error pulling APK:', error);
      setMessage('Error pulling APK.');
    })
    .finally(() => {
      setLoading(false); 
    });
  };

  const handleCloseMessage = () => {
    setMessage('');
    setLoading(false); 
  };

  return (
    <div style={{
      padding: '20px',
      backgroundColor: '#f5f5f5',
      borderRadius: '8px',
      maxWidth: '600px',
      margin: 'auto',
      boxShadow: '0px 4px 8px rgba(0, 0, 0, 0.1)'
    }}>
      <h2 style={{
        textAlign: 'center',
        color: '#333',
        fontSize: '24px',
        marginBottom: '20px'
      }}>Select an APK</h2>
      <ul style={{ listStyleType: 'none', padding: '0' }}>
        {apk.map((a, index) => (
          <li key={index} style={{
            backgroundColor: '#fff',
            padding: '10px',
            marginBottom: '10px',
            borderRadius: '4px',
            display: 'flex',
            justifyContent: 'space-between',
            alignItems: 'center',
            boxShadow: '0px 2px 4px rgba(0, 0, 0, 0.1)'
          }}>
            <span style={{
              fontSize: '18px',
              color: '#555'
            }}>{getApkName(a)}</span>
            <button 
              style={{
                padding: '8px 16px',
                backgroundColor: '#4CAF50',
                color: 'white',
                border: 'none',
                borderRadius: '4px',
                cursor: 'pointer'
              }}
              onClick={() => handleRunApk(a)}
            >
              Download
            </button>
          </li>
        ))}
      </ul>
      {(loading || message) && (
        <div style={{
          position: 'fixed',
          top: 0,
          left: 0,
          width: '100%',
          height: '100%',
          display: 'flex',
          justifyContent: 'center',
          alignItems: 'center',
          backgroundColor: 'rgba(0, 0, 0, 0.3)',
          zIndex: 1000
        }}>
          <div style={{
            textAlign: 'center',
            backgroundColor: '#fff',
            padding: '20px',
            borderRadius: '8px',
            boxShadow: '0px 4px 8px rgba(0, 0, 0, 0.1)'
          }}>
            {loading && (
              <div style={{
                marginBottom: '10px'
              }}>
                <div style={{
                  border: '4px solid rgba(0, 0, 0, 0.1)',
                  borderRadius: '50%',
                  borderTop: '4px solid #4CAF50',
                  width: '40px',
                  height: '40px',
                  animation: 'spin 1s linear infinite',
                  margin: '0 auto'
                }}></div>
                <p style={{ color: '#555' }}>Loading...</p>
              </div>
            )}
            {message && (
              <p style={{ color: 'blue' }}>{message}</p>
            )}
            {(loading || message) && (
              <button 
                style={{
                  marginTop: '20px',
                  padding: '10px 20px',
                  backgroundColor: '#4CAF50',
                  color: 'white',
                  border: 'none',
                  borderRadius: '4px',
                  cursor: 'pointer'
                }}
                onClick={handleCloseMessage}
              >
                OK
              </button>
            )}
          </div>
        </div>
      )}
      <style>
        {`
          @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
          }
        `}
      </style>
    </div>
  );
};

export default Apkrun;
